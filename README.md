# ページング関連知識

## 仮想メモリ

基本的なアイデアは「プログラム全体のサイズが、利用可能な物理メモリの大きさを超えてもよい」ということ

OSは、主メモリ内で現在使用中のプログラム部分とディスクにある残りの部分を記憶しておく

## ページング

ページングとは、ほとんどの仮想メモリシステムで採用されている技法のこと. 仮想アドレス空間を「ページ」と呼ばれる単位に分割し、このページを単位として仮想アドレスから、実アドレスへとデータを変換すること

### 仮想アドレス

プログラムによって生成されたアドレスのこと

### 仮想アドレス空間

仮想アドレスによって形成されている空間のこと

仮想アドレス空間は**ページ**と呼ばれる単位に分割されている。また、物理メモリ内の対応する部分は**ページフレーム**と呼ばれる

ページフレームに存在しないページにアクセスがあった場合は**ページフォールト**が発生する

ページフォールトが発生したときには、OSはほとんど使用されていないページフレームを一つ選択して、そのフレーム内容をディスクへ書き戻す. そして、参照された仮想ページをそのページフレームへ格納する。

## ページ置き換えアルゴリズム

ページフォールトの発生時に、OSはほとんど使用されていないページフレームを一つ選択する。このとき、選択するアルゴリズムがページ置き換えアルゴリズムである。

### NRUアルゴリズム

仮想メモリを装備した大半のコンピュータはページ対応に2ビット設けている

* ビットR(reference bit)はそのページへの読み出しあるいは書き込みがあるとセットされる

* ビットM(modified bit)はそのページへの修正があるとセットされる

OSは最初に全ページの両ビットを0に設定する. また、定期的にビットRを0にする

ページフォールトが発生すると、OSは全ページを調べ、各ページをビットR,ビットMの値に基づいて、次のように分類する

1. クラス0：参照も修正もされていない(ビットR==0, ビットM==0)
2. クラス1：参照されていないが、修正されている(ビットR==0,ビットM==1)
3. クラス2：参照されたが、修正されていない(ビットR==1,ビットM==0)
4. クラス3：参照も修正もされた(ビットR==1,ビットM==1)

**クラス1はクラス3が割り込みによってビットRのみをクリアされたときに生じる**

NRUアルゴリズムでは最下位のクラスからランダムにページを削除する. 

## ページングシミュレータの説明

### 各ファイルについての説明

#### main.c

* 実行に使うmain()がある

#### pagingsim.c

* main()で使用する関数や、その中で使用する関数がある

#### util.c

* ページングシミュレータ以外で使うことのできる関数がある

* xopen()：ファイルを開き、ファイルポインタを返す
* xmalloc()：引数として与えられたサイズ分のメモリを確保し、その確保した領域を返す

## 動作について

* main()は、引数をうけとり、execute()を実行し、結果を出力する

### execute()について

1. access_memory()はファイルの行が存在する場合は変数pcに各種値を格納し 1 を返す. 存在しなければ 0 を返す. したがって、メモリーのアクセスがある場合は処理を続け、ない場合は処理を終了する
   1. 変数pcから、ページインデックスの値を受け取る. 
   2. is_page_fault()でページフォールトが発生するかを確認する
      1. ページフォールトが発生する場合は、ページフォールトが起きたということを知らせる出力をする
         1. should_pageout()でページアウトの有無を調べる
            1. ある場合は
               1. ページアウトするページフレームをget_pageouted_page_index()で取得
               2. ページアウトが行われたということを知らせる出力をする
               3. ページアウトをpageout()によって実行
            2. ない場合は空いているページフレームがあるので、それを記憶
         2. ページインを実行する
         3. 試用しているページフレームのカウンタを一つ増す
         4. ページインが行われたということを示す出力をする
   3. pcからメモリのアクセスタイプ(書き込み・読み込み・フェッチ)のどれだったのかを調べ、それに合わせて、ページインデックスのビットR,Mを更新
2. ページフォールトの発生回数を返す